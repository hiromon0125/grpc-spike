#!/bin/bash
set -e

# Configuration
IMAGE_NAME="grpc-buf"
DOCKERFILE=".devcontainer/Dockerfile"

# Check if image exists
if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
    echo "Image '$IMAGE_NAME' not found. Building..."
    docker build -t "$IMAGE_NAME" -f "$DOCKERFILE" .
    echo "Image built successfully."
fi

# Run buf command in container
if [ $# -eq 0 ]; then
    echo "Error: No buf command provided."
    echo "Usage: $0 <buf-command> [arguments]"
    echo "Examples:"
    echo "  $0 generate"
    echo "  $0 lint"
    echo "  $0 format -w"
    exit 1
fi

echo "Running: buf $@"
docker run --rm -v "$(pwd):/workspace" -w /workspace "$IMAGE_NAME" buf "$@"
echo "Command completed."